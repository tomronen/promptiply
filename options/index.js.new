(function(){
  // Minimal, defensive options script focused on onboarding helpers and robust binding.
  const STORAGE_ONBOARDING = 'onboarding_completed';

  // helper: safe storage set with chrome.storage.local fallback to localStorage
  function safeSetStorage(key, value){
    try{ if(window.chrome && chrome.storage && chrome.storage.local && chrome.storage.local.set){ const obj = {}; obj[key]=value; chrome.storage.local.set(obj); return; } }catch(_){ }
    try{ localStorage.setItem(key, JSON.stringify(value)); }catch(_){ }
  }

  function logOnboardingError(err, fnName, step){
    try{
      const payload = { message: err && err.message ? err.message : String(err), stack: err && err.stack ? err.stack : null, fn: fnName||null, step: step||null, ts: Date.now() };
      safeSetStorage('promptiply_onboarding_error', payload);
      console.error('[promptiply] onboarding error', payload);
    }catch(_){ }
  }

  // refresh anchors if they exist in DOM
  let $onboardingModal = null, $onboardingBody = null, $onboardingNext = null, $onboardingBack = null, $onboardingFinish = null, $onboardingSteps = [];
  function refreshOnboardingAnchors(){
    try{
      $onboardingModal = document.getElementById('onboarding-modal');
      $onboardingBody = document.getElementById('onboarding-body');
      $onboardingNext = document.getElementById('onboarding-next');
      $onboardingBack = document.getElementById('onboarding-back');
      $onboardingFinish = document.getElementById('onboarding-finish');
      $onboardingSteps = Array.from(document.querySelectorAll('.onboarding-step'))||[];
    }catch(_){ }
  }

  // safeRender wrapper
  function safeRender(name, fn){
    try{
      refreshOnboardingAnchors();
      if(!$onboardingBody){
        const modal = document.getElementById('onboarding-modal') || document.createElement('div');
        if(!modal.parentElement) document.body.appendChild(modal);
        const div = document.createElement('div'); div.id = 'onboarding-body'; modal.appendChild(div);
        $onboardingBody = div;
      }
      return fn();
    }catch(e){
      try{ logOnboardingError(e, name); }catch(_){ }
    }
  }

  // simple onboardingState container
  let onboardingState = { step:1, selectedMode:'api', selectedProvider:'openai', apiKey:'', model:'', profileName:'' };

  function openOnboardingWizard(){ try{ refreshOnboardingAnchors(); onboardingState = { step:1, selectedMode:'api', selectedProvider:'openai', apiKey:'', model:'', profileName:'' }; $onboardingModal && $onboardingModal.classList.add('modal-show'); setOnboardingStep(1); }catch(e){ logOnboardingError(e,'openOnboardingWizard'); } }
  function closeOnboardingWizard(){ try{ refreshOnboardingAnchors(); $onboardingModal && $onboardingModal.classList.remove('modal-show'); safeSetStorage(STORAGE_ONBOARDING, true); }catch(e){ logOnboardingError(e,'closeOnboardingWizard'); } }

  function setOnboardingStep(step){ try{ onboardingState.step = Math.max(1, Math.min(4, step)); refreshOnboardingAnchors(); $onboardingSteps.forEach(s=>s.classList.toggle('active', Number(s.dataset.step)===onboardingState.step)); $onboardingBack && $onboardingBack.classList.toggle('tab-panel-hidden', onboardingState.step===1); $onboardingNext && $onboardingNext.classList.toggle('tab-panel-hidden', onboardingState.step===4); $onboardingFinish && $onboardingFinish.classList.toggle('wizard-save-hidden', onboardingState.step!==4);
      // call renderers defensively
      if(onboardingState.step===1) renderModesStep(); else if(onboardingState.step===2) renderSetupStep(); else if(onboardingState.step===3) renderProfileStep(); else renderSuccessStep();
    }catch(e){ logOnboardingError(e,'setOnboardingStep', step); } }

  function renderModesStep(){ return safeRender('renderModesStep', ()=>{
    if(!$onboardingBody) return;
    $onboardingBody.innerHTML = '\n      <div class="onboarding-section">\n        <h3>Choose Your Refinement Mode</h3>\n        <p>promptiply offers three ways to refine your prompts. Choose the one that fits your needs:</p>\n      </div>\n      <div class="mode-card" data-mode="api" tabindex="0">\n        <h3>API Mode</h3>\n        <p>Uses your API key for reliable refinements.</p>\n      </div>\n      <div class="mode-card" data-mode="webui" tabindex="0">\n        <h3>WebUI Mode</h3>\n        <p>Automates the web UI (no key required).</p>\n      </div>\n      <div class="mode-card" data-mode="local" tabindex="0">\n        <h3>Local Mode</h3>\n        <p>Runs a model locally in the browser.</p>\n      </div>\n    ';
    Array.from($onboardingBody.querySelectorAll('.mode-card')).forEach(card=>{
      card.addEventListener('click', ()=>{ onboardingState.selectedMode = card.dataset.mode; Array.from($onboardingBody.querySelectorAll('.mode-card')).forEach(c=>c.classList.remove('selected')); card.classList.add('selected'); });
      card.addEventListener('keydown', ev=>{ if(ev.key==='Enter'||ev.key===' ') { ev.preventDefault(); card.click(); } });
    });
  }); }

  function renderSetupStep(){ return safeRender('renderSetupStep', ()=>{
    if(!$onboardingBody) return; $onboardingBody.innerHTML = '<div class="onboarding-section"><h3>Setup</h3><p>Configure provider or skip.</p></div><div class="actions"><button id="ob-skip">Skip</button><button id="ob-next">Next</button></div>';
    setTimeout(()=>{ document.getElementById('ob-next')?.addEventListener('click', ()=>setOnboardingStep(onboardingState.step+1)); document.getElementById('ob-skip')?.addEventListener('click', ()=>closeOnboardingWizard()); },10);
  }); }

  function renderProfileStep(){ return safeRender('renderProfileStep', ()=>{ if(!$onboardingBody) return; $onboardingBody.innerHTML = '<div class="onboarding-section"><h3>Create Profile (optional)</h3><p>Add a profile to tailor refinements.</p></div><div class="field"><label>Name</label><input id="ob-profile-name" type="text" /></div><div class="actions"><button id="ob-prev">Back</button><button id="ob-next">Next</button></div>'; setTimeout(()=>{ document.getElementById('ob-next')?.addEventListener('click', ()=>{ const n=document.getElementById('ob-profile-name'); if(n) onboardingState.profileName = n.value.trim(); setOnboardingStep(onboardingState.step+1); }); document.getElementById('ob-prev')?.addEventListener('click', ()=>setOnboardingStep(onboardingState.step-1)); },10); }); }

  function renderSuccessStep(){ return safeRender('renderSuccessStep', ()=>{ if(!$onboardingBody) return; $onboardingBody.innerHTML = '<div class="onboarding-success"><h3>Done</h3><p>You are all set.</p></div><div class="actions"><button id="ob-finish">Finish</button></div>'; setTimeout(()=>{ document.getElementById('ob-finish')?.addEventListener('click', ()=>{ try{ safeSetStorage(STORAGE_ONBOARDING, true); }catch(_){ } closeOnboardingWizard(); setTimeout(()=>location.reload(),200); }); },10); }); }

  function handleOnboardingNext(){ try{ if(onboardingState.step===2){ /* collect setup fields if needed */ } setOnboardingStep(onboardingState.step+1); }catch(e){ logOnboardingError(e,'handleOnboardingNext'); } }

  // Bind robust Run Onboarding handler (immediate attach + delegated fallback)
  function attachRunOnboarding(){ try{
    const btn = document.getElementById('run-onboarding');
    if(btn && !btn.dataset.prOnboardingAttached){
      btn.addEventListener('click', ()=>{
        try{ safeSetStorage('promptiply_onboarding_click', { timestamp: Date.now() }); }catch(_){ }
        try{ if(typeof openOnboardingWizard==='function') return openOnboardingWizard(); if(typeof window.startOnboarding==='function') return window.startOnboarding(); setOnboardingStep(1); $onboardingModal && $onboardingModal.classList.add('modal-show'); }catch(e){ logOnboardingError(e,'runOnboarding_click'); }
      });
      try{ btn.dataset.prOnboardingAttached='1'; }catch(_){ }
      return true;
    }
    return false;
  }catch(e){ return false; } }

  // Try immediate attach, else DOMContentLoaded, else delegated click
  if(!attachRunOnboarding()){
    document.addEventListener('DOMContentLoaded', ()=>{ try{ attachRunOnboarding(); }catch(_){ } });
    if(!document._prOnboardingDelegated){
      document.addEventListener('click', ev=>{
        try{
          const t = ev.target && ev.target.closest && ev.target.closest('#run-onboarding');
          if(t){ try{ safeSetStorage('promptiply_onboarding_click', { timestamp: Date.now() }); }catch(_){ }
            try{ if(typeof openOnboardingWizard==='function') return openOnboardingWizard(); if(typeof window.startOnboarding==='function') return window.startOnboarding(); setOnboardingStep(1); $onboardingModal && $onboardingModal.classList.add('modal-show'); }catch(e){ logOnboardingError(e,'runOnboarding_delegated'); }
          }
        }catch(_){ }
      }, true);
      try{ document._prOnboardingDelegated = true; }catch(_){ }
    }
  }

  // Expose helpers
  try{ window.openOnboardingWizard = openOnboardingWizard; window.setOnboardingStep = setOnboardingStep; window.getOnboardingState = ()=>onboardingState; window.startOnboarding = function(){ try{ openOnboardingWizard(); }catch(e){ logOnboardingError(e,'startOnboarding'); } }; }catch(_){ }

  // Auto-open if not completed (non-blocking)
  try{ chrome && chrome.storage && chrome.storage.local && chrome.storage.local.get && chrome.storage.local.get([STORAGE_ONBOARDING], (d)=>{ if(!d[STORAGE_ONBOARDING]) setTimeout(()=>openOnboardingWizard(), 600); }); }catch(_){ setTimeout(()=>{/*no-op*/},0); }

})();
